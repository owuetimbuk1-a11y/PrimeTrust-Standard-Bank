<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PrimeTrust</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {margin:0;font-family:Arial,sans-serif;background:#0f172a;color:#fff;}
.container{max-width:420px;margin:60px auto;background:#020617;padding:20px;border-radius:8px;}
h2{text-align:center;}
input,button{width:100%;padding:12px;margin-top:10px;}
input{background:#020617;color:white;border:1px solid #334155;}
button{background:#2563eb;color:white;border:none;cursor:pointer;}
button:disabled{opacity:0.6;}
.hidden{display:none;}
#msg,#actionMsg{margin-top:10px;text-align:center;word-break:break-word;}
</style>
</head>

<body>

<div class="container" id="loginBox">
  <h2>PrimeTrust Login</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <div id="msg"></div>
</div>

<div class="container hidden" id="dashboard">
  <h2 id="roleTitle"></h2>
  <button id="bankerBtn">Banker Action</button>
  <button id="adminBtn">Admin Action</button>
  <button id="transferBtn">User Transfer</button>
  <div id="actionMsg"></div>
</div>

<script>
/* =======================
   CONFIG: Supabase + Edge Function URLs
======================= */
const SUPABASE_URL = "https://beahjjbypfpfqgnelzro.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJlYWhqamJ5cGZwZnFnbmVsenJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMzc1MzgsImV4cCI6MjA4MzcxMzUzOH0.3dL_wsIjrSYioi5CVM2FSvzZzf44cwXh_bDvKh9xgh0";

const ENDPOINTS = {
  authLogin:    "https://beahjjbypfpfqgnelzro.supabase.co/functions/v1/auth-login",
  bankerAction: "https://beahjjbypfpfqgnelzro.supabase.co/functions/v1/banker-actions",
  adminAction:  "https://beahjjbypfpfqgnelzro.supabase.co/functions/v1/admin-actions",
  userTransfer: "https://beahjjbypfpfqgnelzro.supabase.co/functions/v1/user-transfer"
};

/* =======================
   DOM ELEMENTS
======================= */
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const msg = document.getElementById("msg");
const dashboard = document.getElementById("dashboard");
const loginBox = document.getElementById("loginBox");
const roleTitle = document.getElementById("roleTitle");
const actionMsg = document.getElementById("actionMsg");
const bankerBtn = document.getElementById("bankerBtn");
const adminBtn = document.getElementById("adminBtn");
const transferBtn = document.getElementById("transferBtn");

let sessionToken = null;
let userRole = null;

/* =======================
   SAFE FETCH HELPER
======================= */
async function safeFetch(url, options = {}) {
  try {
    if (!options.body) options.body = JSON.stringify({});
    const res = await fetch(url, options);
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = text; }
    return { ok: res.ok, status: res.status, data };
  } catch (err) {
    console.error("Network/CORS error:", err);
    return { ok: false, status: 0, data: err.message };
  }
}

/* =======================
   LOGIN
======================= */
loginBtn.onclick = async () => {
  msg.innerText = "";
  loginBtn.disabled = true;

  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();

  if (!email || !password) {
    msg.innerText = "Email and password required";
    loginBtn.disabled = false;
    return;
  }

  const { ok, data } = await safeFetch(ENDPOINTS.authLogin, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "apikey": SUPABASE_ANON_KEY
    },
    body: JSON.stringify({ email, password })
  });

  console.log("Login response:", data);

  if (!ok) {
    msg.innerText = data?.error || "Login failed";
    loginBtn.disabled = false;
    return;
  }

  sessionToken = data.session?.access_token || data.access_token;
  userRole = data.user?.role || "user";

  if (!sessionToken) {
    msg.innerText = "No session token returned";
    loginBtn.disabled = false;
    return;
  }

  loginBox.classList.add("hidden");
  dashboard.classList.remove("hidden");
  roleTitle.innerText = userRole.toUpperCase() + " DASHBOARD";
  loginBtn.disabled = false;
};

/* =======================
   SECURED ACTIONS
======================= */
bankerBtn.onclick = () => secureAction(ENDPOINTS.bankerAction);
adminBtn.onclick  = () => secureAction(ENDPOINTS.adminAction);
transferBtn.onclick = () => secureAction(ENDPOINTS.userTransfer);

async function secureAction(url) {
  actionMsg.innerText = "Processing...";
  const { ok, data } = await safeFetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + sessionToken
    },
    body: JSON.stringify({})
  });

  console.log("Action response:", data);
  if (!ok) actionMsg.innerText = `Error: ${JSON.stringify(data)}`;
  else actionMsg.innerText = JSON.stringify(data);
}
</script>

</body>
  </html>
